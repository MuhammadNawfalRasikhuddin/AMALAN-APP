<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AMANAH - Ultimate & News System</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #059669;
        --bg: #f8fafc;
        --text: #111827;
        --sub: #6b7280;
        --border: #e2e8f0;
        --accent: #10b981;
        --verify: #1d9bf0;
        --white: #ffffff;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Plus Jakarta Sans", sans-serif;
      }
      body {
        background-color: var(--bg);
        color: var(--text);
      }

      /* HEADER & NAVIGATION */
      header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        border-bottom: 1px solid var(--border);
        padding: 12px 5%;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .logo {
        font-weight: 800;
        font-size: 1.4rem;
        color: var(--primary);
        cursor: pointer;
      }
      .nav-tools {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .search-input {
        padding: 8px 15px;
        border-radius: 99px;
        border: 1px solid var(--border);
        outline: none;
        width: 150px;
        transition: 0.3s;
      }
      .search-input:focus {
        width: 200px;
        border-color: var(--primary);
      }

      /* BUTTONS */
      .btn {
        border: none;
        padding: 10px 18px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        transition: 0.2s;
        font-size: 0.85rem;
      }
      .btn-p {
        background: var(--primary);
        color: white;
      }
      .btn-lang {
        background: #f1f5f9;
        border: 1px solid var(--border);
      }

      /* LAYOUT */
      .container {
        max-width: 850px;
        margin: 0 auto;
        padding: 30px 20px;
      }
      .page {
        display: none;
        animation: fadeIn 0.4s ease;
      }
      .page.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* CARDS & GRID */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-top: 25px;
      }
      .m-card {
        background: var(--white);
        border: 1px solid var(--border);
        padding: 25px;
        border-radius: 20px;
        cursor: pointer;
        transition: 0.3s;
      }
      .m-card:hover {
        border-color: var(--primary);
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      /* NEWS SECTION */
      .news-highlight {
        margin-top: 40px;
      }
      .news-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .news-card {
        background: white;
        border-radius: 20px;
        border: 1px solid var(--border);
        overflow: hidden;
        cursor: pointer;
        transition: 0.3s;
      }
      .news-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
      }
      .news-card img {
        width: 100%;
        height: 160px;
        object-fit: cover;
      }
      .news-info {
        padding: 15px;
      }
      .news-tag {
        font-size: 0.65rem;
        font-weight: 800;
        color: var(--primary);
        text-transform: uppercase;
      }
      .news-title {
        font-size: 1rem;
        font-weight: 700;
        margin: 5px 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* LOAD MORE BUTTON */
      .load-more-container {
        text-align: center;
        margin-top: 30px;
      }
      .btn-load {
        background: #f1f5f9;
        color: var(--primary);
        border: 1px solid var(--border);
        padding: 10px 25px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
      }

      /* FORUM STYLING */
      .post-card {
        background: var(--white);
        border: 1px solid var(--border);
        padding: 20px;
        border-radius: 20px;
        margin-bottom: 20px;
      }
      .user-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      .avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--primary);
      }
      .reply-thread {
        margin-left: 40px;
        border-left: 2px solid var(--border);
        padding-left: 15px;
        margin-top: 15px;
      }
      .reply-item {
        margin-bottom: 10px;
        font-size: 0.9rem;
        padding: 5px 0;
      }

      /* MODAL */
      #modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal {
        background: white;
        padding: 25px;
        border-radius: 20px;
        width: 90%;
        max-width: 400px;
      }

      /* QUEST LIST */
      .q-box {
        background: var(--white);
        border-radius: 20px;
        border: 1px solid var(--border);
        overflow: hidden;
      }
      .q-row {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
      }
      .q-row:hover {
        background: #f9fafb;
      }
    </style>
  </head>
  <body>
    <div id="modal-overlay">
      <div class="modal">
        <h3 id="txt-modal-title">Balas Diskusi</h3>
        <textarea
          id="reply-input"
          style="
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin: 15px 0;
            outline: none;
            resize: none;
          "
          rows="3"
          placeholder="Tulis jawaban..."
        ></textarea>
        <div style="display: flex; gap: 10px; justify-content: flex-end">
          <button
            class="btn"
            style="background: #f1f5f9"
            onclick="closeModal()"
          >
            Batal
          </button>
          <button class="btn btn-p" id="txt-btn-send" onclick="sendReply()">
            Kirim
          </button>
        </div>
      </div>
    </div>

    <header id="navbar" style="display: none">
      <div class="logo" onclick="navigateTo('dashboard')">AMANAH.</div>
      <div class="nav-tools">
        <input
          type="text"
          class="search-input"
          id="search-box"
          placeholder="Cari misi..."
          onkeyup="filterMisi()"
        />
        <button class="btn btn-lang" id="lang-btn" onclick="toggleLanguage()">
          üåê ID
        </button>
        <button
          class="btn btn-p"
          style="background: #ef4444"
          onclick="location.reload()"
        >
          Logout
        </button>
      </div>
    </header>

    <div class="container">
      <section
        id="page-login"
        class="page active"
        style="text-align: center; padding-top: 20vh"
      >
        <h1
          style="
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: -2px;
          "
        >
          AMANAH.
        </h1>
        <p id="txt-sub">Sistem Integritas & Kabar Muslim Modern</p>
        <br />
        <input
          type="text"
          id="user-name"
          placeholder="Nama Anda"
          style="
            padding: 15px;
            width: 100%;
            max-width: 320px;
            border-radius: 15px;
            border: 1px solid var(--border);
            outline: none;
          "
        />
        <br /><br />
        <button
          class="btn btn-p"
          id="txt-btn-login"
          style="padding: 15px 50px"
          onclick="login()"
        >
          Masuk
        </button>
      </section>

      <section id="page-dashboard" class="page">
        <h2 id="txt-hi" style="font-size: 1.8rem; margin-bottom: 25px">
          Selamat Datang
        </h2>
        <div class="grid">
          <div class="m-card" onclick="navigateTo('misi-list')">
            <h3 id="txt-m1">üõ°Ô∏è Vault 8 Pilar</h3>
            <p style="color: var(--sub); font-size: 0.8rem; margin-top: 5px">
              Checklist 64 poin integritas harian.
            </p>
          </div>
          <div class="m-card" onclick="navigateTo('forum')">
            <h3 id="txt-m2">üí¨ Forum Mentor</h3>
            <p style="color: var(--sub); font-size: 0.8rem; margin-top: 5px">
              Tanya jawab ustadz & diskusi.
            </p>
          </div>
          <div class="m-card" onclick="navigateTo('score')">
            <h3 id="txt-m3">üìä Raport Integritas</h3>
            <p style="color: var(--sub); font-size: 0.8rem; margin-top: 5px">
              Lihat Grade A-D Anda.
            </p>
          </div>
        </div>

        <div class="news-highlight">
          <h3 id="txt-news-head">Kabar Muslim Terkini</h3>
          <div class="news-grid" id="news-feed-dashboard"></div>
          <div class="load-more-container">
            <button
              id="btn-load-more"
              class="btn-load"
              onclick="loadMoreNews()"
            >
              Munculkan Berita Lainnya
            </button>
          </div>
        </div>
      </section>

      <section id="page-news-detail" class="page">
        <button class="btn btn-lang" onclick="handleBack()">‚Üê Kembali</button>
        <div id="news-content-area" style="margin-top: 20px"></div>
      </section>

      <section id="page-misi-list" class="page">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2 id="txt-misi-head">8 Pilar Utama</h2>
          <button class="btn btn-lang" onclick="handleBack()">‚Üê Kembali</button>
        </div>
        <div class="grid" id="misi-grid-container"></div>
      </section>

      <section id="page-quest" class="page">
        <button class="btn btn-lang" onclick="handleBack()">‚Üê Kembali</button>
        <h2 id="active-misi-title" style="margin: 20px 0">Detail Misi</h2>
        <div class="q-box" id="quest-container"></div>
        <button
          class="btn btn-p"
          id="txt-btn-save"
          style="width: 100%; margin-top: 20px; padding: 18px"
          onclick="saveQuest()"
        >
          Simpan Progress
        </button>
      </section>

      <section id="page-forum" class="page">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
          "
        >
          <h2 id="txt-f-title">Forum Diskusi</h2>
          <button class="btn btn-lang" onclick="handleBack()">‚Üê Kembali</button>
        </div>
        <div
          style="
            background: white;
            padding: 20px;
            border-radius: 20px;
            border: 1px solid var(--border);
            margin-bottom: 30px;
          "
        >
          <textarea
            id="post-input"
            placeholder="Tulis pertanyaanmu..."
            style="width: 100%; border: none; outline: none; font-size: 1rem"
          ></textarea>
          <button class="btn btn-p" style="float: right" onclick="addPost()">
            Posting
          </button>
          <div style="clear: both"></div>
        </div>
        <div id="forum-feed"></div>
      </section>

      <section id="page-score" class="page" style="text-align: center">
        <div
          class="m-card"
          style="max-width: 400px; margin: 0 auto; padding: 50px"
        >
          <h2 id="txt-grade-title">Grade Anda</h2>
          <div
            id="final-grade"
            style="font-size: 6rem; font-weight: 800; color: var(--primary)"
          >
            -
          </div>
          <h3 id="final-percent">0%</h3>
          <button
            class="btn btn-p"
            style="margin-top: 20px"
            onclick="handleBack()"
          >
            Kembali
          </button>
        </div>
      </section>
    </div>

    <script>
      // API URL diarahkan ke localhost (Uvicorn yang sedang jalan di laptopmu)
      const API_URL = "http://127.0.0.1:8000";

      let allNews = [];
      let visibleCount = 6;
      let user = "";
      let currentLang = "ID";
      let progress = {};
      let activeId = null;

      const mDb = [
        {
          id: 1,
          title: "Kejujuran Lisan",
          icon: "‚öñÔ∏è",
          q: [
            "Tidak bohong",
            "Akui salah",
            "No Hoax",
            "Sesuai fakta",
            "Jujur niat",
            "Tak melebihkan",
            "Bicara benar",
            "Berani jujur",
          ],
        },
        {
          id: 2,
          title: "Amanah Harta",
          icon: "üí∞",
          q: [
            "No suap",
            "Zakat rutin",
            "Timbangan pas",
            "Cacat barang disebut",
            "No korupsi waktu",
            "Gaji halal",
            "Sedekah",
            "Catat hutang",
          ],
        },
        {
          id: 3,
          title: "Janji & Komitmen",
          icon: "ü§ù",
          q: [
            "Tepat waktu",
            "No ingkar",
            "Deadline aman",
            "Hutang lunas",
            "Akad jelas",
            "Rahasia aman",
            "Konsisten",
            "Tanggung jawab",
          ],
        },
        {
          id: 4,
          title: "Adab Digital",
          icon: "üì±",
          q: [
            "No bully",
            "Komen sopan",
            "Filter konten",
            "No ghibah",
            "Izin tag",
            "Jaga privasi",
            "Share manfaat",
            "Bijak sosmed",
          ],
        },
      ];

      const lang = {
        ID: {
          sub: "Sistem Integritas & Kabar Muslim Modern",
          btnLogin: "Masuk",
          hi: "Selamat Datang",
          m1: "üõ°Ô∏è Vault 8 Pilar",
          m2: "üí¨ Forum Mentor",
          m3: "üìä Raport Integritas",
          newsHead: "Kabar Muslim Terkini",
          misiHead: "8 Pilar Utama",
          btnSave: "Simpan Progress",
          fTitle: "Forum Diskusi",
          btnSend: "Kirim",
          gradeTitle: "Grade Anda",
        },
        EN: {
          sub: "Modern Digital Integrity & News System",
          btnLogin: "Login",
          hi: "Welcome",
          m1: "üõ°Ô∏è 8 Pillar Vault",
          m2: "üí¨ Expert Forum",
          m3: "üìä Integrity Report",
          newsHead: "Latest Muslim News",
          misiHead: "8 Main Pillars",
          btnSave: "Save Progress",
          fTitle: "Discussion Forum",
          btnSend: "Send",
          gradeTitle: "Your Grade",
        },
      };

      function login() {
        user = document.getElementById("user-name").value;
        if (!user) return alert("Masukkan nama!");
        document.getElementById("navbar").style.display = "flex";
        updateUI();
        navigateTo("dashboard");
      }

      function navigateTo(p) {
        window.history.pushState({ page: p }, "", "#" + p);
        show(p);
      }
      function show(p) {
        document
          .querySelectorAll(".page")
          .forEach((pg) => pg.classList.remove("active"));
        document.getElementById("page-" + p).classList.add("active");
        if (p === "dashboard") fetchNews();
        if (p === "misi-list") renderMisi();
        if (p === "score") calcScore();
        window.scrollTo(0, 0);
      }

      // LOGIKA BERITA (API CONNECTION)
      async function fetchNews() {
        try {
          const res = await fetch(`${API_URL}/news`);
          allNews = await res.json();
          renderNews();
        } catch (e) {
          document.getElementById("news-feed-dashboard").innerHTML =
            "Gagal konek ke API Lokal. Pastikan Uvicorn menyala!";
        }
      }

      function renderNews() {
        const container = document.getElementById("news-feed-dashboard");
        const currentItems = allNews.slice(0, visibleCount);
        container.innerHTML = currentItems
          .map(
            (n) => `
                <div class="news-card" onclick="openNewsDetail(${n.id})">
                    <img src="${n.image}">
                    <div class="news-info">
                        <span class="news-tag">${n.category}</span>
                        <div class="news-title">${n.title}</div>
                        <p style="font-size:0.75rem; color:var(--sub)">${n.summary}</p>
                    </div>
                </div>
            `
          )
          .join("");
        if (visibleCount >= allNews.length)
          document.getElementById("btn-load-more").style.display = "none";
      }

      function loadMoreNews() {
        visibleCount += 3;
        renderNews();
      }

      function openNewsDetail(id) {
        const n = allNews.find((x) => x.id === id);
        document.getElementById("news-content-area").innerHTML = `
        <img src="${n.image}" style="width:100%; border-radius:20px;">
        <h1 style="margin:20px 0;">${n.title}</h1>
        <p style="line-height:1.8;">${n.content}</p>
        <br>
        <a href="${n.link}" target="_blank" class="btn btn-p" style="text-decoration:none">Baca Selengkapnya di Sumber Asli</a>
    `;
        navigateTo("news-detail");
      }

      // FUNGSI PENDUKUNG LAINNYA (TETAP ADA)
      function renderMisi() {
        const container = document.getElementById("misi-grid-container");
        container.innerHTML = mDb
          .map(
            (m) =>
              `<div class="m-card" onclick="openQuest(${m.id})"><h3>${m.icon} ${
                m.title
              }</h3><p>${progress[m.id] || 0}/8 Selesai</p></div>`
          )
          .join("");
      }

      function openQuest(id) {
        activeId = id;
        const m = mDb.find((x) => x.id === id);
        document.getElementById("active-misi-title").innerText = m.title;
        document.getElementById("quest-container").innerHTML = m.q
          .map(
            (q) =>
              `<div class="q-row" onclick="this.querySelector('input').click()"><input type="checkbox" class="q-chk"> <span>${q}</span></div>`
          )
          .join("");
        navigateTo("quest");
      }

      function saveQuest() {
        progress[activeId] = document.querySelectorAll(".q-chk:checked").length;
        alert("Progres disimpan!");
        handleBack();
      }

      function calcScore() {
        let total = 0;
        Object.values(progress).forEach((v) => (total += v));
        const percent = Math.round((total / 32) * 100);
        document.getElementById("final-percent").innerText = percent + "%";
        const g = document.getElementById("final-grade");
        g.innerText =
          percent >= 90 ? "A" : percent >= 70 ? "B" : percent >= 40 ? "C" : "D";
      }

      function toggleLanguage() {
        currentLang = currentLang === "ID" ? "EN" : "ID";
        document.getElementById("lang-btn").innerText = "üåê " + currentLang;
        updateUI();
      }

      function updateUI() {
        const t = lang[currentLang];
        document.getElementById("txt-sub").innerText = t.sub;
        document.getElementById("txt-btn-login").innerText = t.btnLogin;
        document.getElementById("txt-hi").innerText =
          t.hi + (user ? ", " + user : "");
        document.getElementById("txt-news-head").innerText = t.newsHead;
        document.getElementById("txt-misi-head").innerText = t.misiHead;
        document.getElementById("txt-btn-save").innerText = t.btnSave;
        document.getElementById("txt-grade-title").innerText = t.gradeTitle;
      }

      window.onpopstate = (e) => {
        if (e.state) show(e.state.page);
      };
      function handleBack() {
        window.history.back();
      }
    </script>
  </body>
</html>
